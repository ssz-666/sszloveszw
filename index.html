<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Us. Forever | æ°¸æ’è®°å½•</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/typeit@8.7.1/dist/index.umd.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400;600&family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    serif: ['Noto Serif SC', 'serif'],
                    display: ['Cinzel', 'serif'],
                },
                animation: {
                    'blob': 'blob 7s infinite',
                    'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    'shimmer': 'shimmer 2s linear infinite',
                    'float': 'float 3s ease-in-out infinite',
                },
                keyframes: {
                    blob: {
                        '0%': { transform: 'translate(0px, 0px) scale(1)' },
                        '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                        '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                        '100%': { transform: 'translate(0px, 0px) scale(1)' },
                    },
                    shimmer: {
                        '0%': { backgroundPosition: '-200% 0' },
                        '100%': { backgroundPosition: '200% 0' }
                    },
                    float: {
                        '0%, 100%': { transform: 'translateY(0)' },
                        '50%': { transform: 'translateY(-10px)' }
                    }
                }
            }
        }
    }
</script>

<style>
    /* --- æ ¸å¿ƒæ ·å¼ --- */
    body {
        background-color: #050505;
        color: #e2e2e2;
        overflow-x: hidden;
        position: relative;
        cursor: default;
    }

    /* é”å±ç•Œé¢ */
    #lock-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: #000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
    }
    #lock-screen.unlocked { transform: translateY(-100%); }
    
    .passcode-dot {
        width: 12px; height: 12px; border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.3);
        transition: all 0.3s;
    }
    .passcode-dot.active { background: white; border-color: white; box-shadow: 0 0 10px white; }
    .passcode-dot.error { background: #ef4444; border-color: #ef4444; animation: shake 0.5s; }

    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

    /* èƒŒæ™¯å™ªç‚¹ */
    body::after {
        content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        pointer-events: none; z-index: 1; opacity: 0.5;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* ç»ç’ƒæ‹Ÿæ€ */
    .premium-glass {
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* èšå…‰ç¯å¡ç‰‡ */
    .spotlight-card {
        background: rgba(20, 20, 23, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        position: relative; overflow: hidden;
        transition: all 0.4s ease;
        z-index: 10;
    }
    .spotlight-card::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 24px; padding: 1px;
        background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.15), transparent 40%);
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude;
        opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    .spotlight-card:hover::before { opacity: 1; }
    .spotlight-card:hover { transform: translateY(-5px); background: rgba(30, 30, 35, 0.6); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.8); }

    /* æ–‡å­—æ¸å˜ */
    .gradient-text {
        background: linear-gradient(135deg, #fff 0%, #9ca3af 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    /* AI æŒ‰é’®æ ·å¼ */
    .ai-btn-gradient {
        background: linear-gradient(110deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
        background-size: 200% 200%;
        animation: shimmer 3s linear infinite;
        border: none;
        color: white;
    }
    .ai-btn-gradient:hover {
        filter: brightness(1.1);
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
    }
    
    /* è¾…åŠ©æŒ‰é’® */
    .btn-secondary {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #e2e2e2;
        transition: all 0.3s;
    }
    .btn-secondary:hover {
        background: rgba(255,255,255,0.15);
        border-color: rgba(255,255,255,0.3);
    }

    /* æ¨¡æ€æ¡† */
    .modal-view {
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(0,0,0,0.9);
        backdrop-filter: blur(20px);
        display: none; opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-view.active { display: flex; }
    .modal-content {
        background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
    }

    /* çˆ±å¿ƒæ‹–å°¾ */
    .heart-trail {
        position: fixed; pointer-events: none; z-index: 9999;
        font-size: 20px; color: #f472b6; opacity: 0;
        animation: floatUp 1s ease-out forwards;
    }
    @keyframes floatUp {
        0% { transform: translateY(0) scale(1); opacity: 0.8; }
        100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
    }

    /* éŸ³ä¹æ’­æ”¾å™¨ */
    .music-player {
        position: fixed; bottom: 2rem; right: 2rem; z-index: 50;
        display: flex; align-items: center; gap: 1rem;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
        padding: 0.5rem 0.5rem 0.5rem 1.5rem; border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.1);
        transition: all 0.3s;
    }
    .music-player:hover { background: rgba(20,20,20,0.8); border-color: rgba(255,255,255,0.2); }
    .music-waves span {
        display: inline-block; width: 3px; height: 10px; background: #fff;
        border-radius: 2px; animation: none;
    }
    .music-playing .music-waves span { animation: wave 1s infinite ease-in-out; }
    .music-playing .music-waves span:nth-child(1) { animation-delay: 0.1s; }
    .music-playing .music-waves span:nth-child(2) { animation-delay: 0.2s; }
    .music-playing .music-waves span:nth-child(3) { animation-delay: 0.3s; }
    .music-playing .music-waves span:nth-child(4) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 100% { height: 5px; opacity: 0.5; } 50% { height: 15px; opacity: 1; } }

    /* åŠ è½½å±‚ */
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column;}
    .spinner { width: 40px; height: 40px; border: 2px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* è¾“å…¥æ¡†é‡ç½® */
    input, textarea { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; outline: none; }
    input:focus, textarea:focus { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }
</style>
</head>
<body class="antialiased selection:bg-pink-500/30 selection:text-white">

<!-- é”å±ç•Œé¢ -->
<div id="lock-screen">
    <div class="text-center mb-8">
        <i class="fas fa-lock text-3xl text-gray-400 mb-4"></i>
        <h2 class="text-2xl font-display text-white tracking-widest">PRIVATE SPACE</h2>
        <p class="text-xs text-gray-500 mt-2 tracking-[0.2em] uppercase">Enter Passcode to Access</p>
    </div>
    <div class="flex gap-4 mb-8" id="passcode-display">
        <div class="passcode-dot"></div><div class="passcode-dot"></div><div class="passcode-dot"></div><div class="passcode-dot"></div>
    </div>
    <div class="grid grid-cols-3 gap-6 text-xl font-light">
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(1)">1</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(2)">2</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(3)">3</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(4)">4</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(5)">5</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(6)">6</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(7)">7</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(8)">8</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(9)">9</button>
        <button class="w-16 h-16 rounded-full border-transparent text-sm text-gray-400" onclick="clearPasscode()">CLR</button>
        <button class="w-16 h-16 rounded-full border border-white/10 hover:bg-white/10 transition flex items-center justify-center" onclick="enterDigit(0)">0</button>
        <button class="w-16 h-16 rounded-full border-transparent text-sm text-gray-400" onclick="backspace()"><i class="fas fa-backspace"></i></button>
    </div>
</div>

<canvas id="canvas-bg" class="fixed inset-0 pointer-events-none"></canvas>
<audio id="bgm-audio"></audio>

<div id="loading-layer" class="loading-overlay">
    <div class="spinner mb-4"></div>
    <div id="loading-text" class="text-xs text-gray-400 font-mono tracking-widest">Processing...</div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨ -->
<div class="music-player group" id="music-player-ui">
    <div class="music-waves h-4 flex items-end gap-1 mr-2">
        <span></span><span></span><span></span><span></span>
    </div>
    <div class="text-xs font-mono text-gray-300 w-24 truncate" id="music-title">Paused</div>
    <button onclick="toggleBGM()" id="bgm-btn" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
        <i class="fas fa-play text-xs pl-0.5"></i>
    </button>
</div>

<!-- å¯¼èˆª -->
<nav class="fixed top-0 w-full z-40 premium-glass transition-all duration-500">
    <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
        <div class="text-2xl font-display font-bold tracking-tight text-white flex items-center gap-2">
            <i class="fas fa-infinity text-xs text-purple-400"></i> US. 
        </div>
        <label for="file-upload" class="cursor-pointer group flex items-center space-x-2 px-5 py-2 rounded-full border border-white/10 hover:border-white/30 hover:bg-white/5 transition-all">
            <i class="fas fa-cloud-upload-alt text-gray-400 group-hover:text-white transition-colors"></i>
            <span class="text-xs font-bold text-gray-300 group-hover:text-white">Upload</span>
        </label>
        <input id="file-upload" type="file" class="hidden" accept="image/*" onchange="uploadToCloud(event)">
    </div>
</nav>

<!-- ä¸»å± -->
<section class="relative h-screen w-full flex flex-col justify-center items-center text-center overflow-hidden z-10">
    <!-- è£…é¥°å…‰æ™• -->
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-[120px] animate-blob mix-blend-screen"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-blue-600/20 rounded-full blur-[120px] animate-blob animation-delay-2000 mix-blend-screen"></div>
    
    <div class="z-10 px-4 flex flex-col items-center">
        <span class="inline-block py-1 px-4 rounded-full bg-white/5 border border-white/10 text-[10px] tracking-[0.3em] font-medium text-gray-400 mb-8 backdrop-blur-sm uppercase">Secure Connection Established</span>
        
        <h1 class="text-6xl md:text-9xl font-bold tracking-tighter mb-6 gradient-text leading-tight font-display" id="typewriter-title"></h1>
        
        <div class="flex items-center gap-6 mt-8 p-1 pr-6 rounded-full bg-white/5 backdrop-blur-md border border-white/10" data-aos="fade-up" data-aos-delay="500">
            <div class="bg-white/10 p-3 rounded-full text-pink-400 animate-pulse-slow">
                <i class="fas fa-heart"></i>
            </div>
            <div class="flex flex-col items-start">
                <span class="text-[10px] text-gray-400 uppercase tracking-widest">Together For</span>
                <div class="flex items-baseline gap-2">
                    <span id="days-counter" class="text-2xl font-serif text-white font-bold">0</span>
                    <span class="text-xs text-gray-500">days</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="absolute bottom-10 text-white/30 text-2xl animate-bounce">
        <i class="fas fa-angle-down"></i>
    </div>
</section>

<!-- åŠŸèƒ½å¡ç‰‡åŒº -->
<section class="py-12 relative z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="flex items-center gap-4 mb-10 pl-2">
            <div class="w-1 h-8 bg-gradient-to-b from-purple-500 to-blue-500 rounded-full"></div>
            <div>
                <h2 class="text-2xl font-bold text-white">Love OS</h2>
                <p class="text-gray-500 text-xs tracking-wider uppercase">Operating System v2.0 + AI Core</p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-12 gap-6" id="cards-container">
            
            <!-- ä¸“å±æ‘„å½±å¸ˆ (æ›¿æ¢äº†åŸæ¥çš„å°è¯´/å¼‚ä¸–ç•Œæ¢é™©) -->
            <div onclick="openPhotoModal()" class="col-span-2 md:col-span-4 spotlight-card h-64 p-8 flex flex-col justify-between cursor-pointer group">
                <div class="flex justify-between items-start z-10">
                    <div class="w-12 h-12 rounded-2xl bg-teal-500/10 border border-teal-500/20 flex items-center justify-center text-teal-400 text-xl group-hover:scale-110 transition-transform">
                        <i class="fas fa-camera"></i>
                    </div>
                    <i class="fas fa-arrow-right text-gray-600 group-hover:text-white -rotate-45 group-hover:rotate-0 transition-all duration-300"></i>
                </div>
                <div class="z-10 relative">
                    <h3 class="font-bold text-gray-100 text-xl group-hover:text-teal-300 transition-colors">ä¸“å±æ‘„å½±å¸ˆ</h3>
                    <p class="text-xs text-gray-500 mt-1">AI Composition Guide</p>
                    <p class="text-sm font-bold text-gray-400 mt-4 font-display">è¾…åŠ©æ„å›¾</p>
                </div>
            </div>

            <!-- æ—¥å† -->
            <div onclick="openCalendarModal()" class="col-span-2 md:col-span-4 spotlight-card h-64 p-8 flex flex-col justify-between cursor-pointer group">
                <div class="flex justify-between items-start z-10">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 border border-blue-500/20 flex items-center justify-center text-blue-400 text-xl group-hover:scale-110 transition-transform">
                        <i class="far fa-calendar-check"></i>
                    </div>
                    <i class="fas fa-arrow-right text-gray-600 group-hover:text-white -rotate-45 group-hover:rotate-0 transition-all duration-300"></i>
                </div>
                <div class="z-10">
                    <h3 class="font-bold text-gray-100 text-xl group-hover:text-blue-300 transition-colors">æœªæ¥è®¡åˆ’</h3>
                    <p class="text-xs text-gray-500 mt-1">Timeline & Date Ideas</p>
                    <p class="text-3xl font-bold text-white mt-4 font-display" id="event-count">0</p>
                </div>
            </div>

            <!-- å¿ƒåŠ¨ç“¶ (ç§»é™¤AI) -->
            <div onclick="openJarModal()" class="col-span-1 md:col-span-2 spotlight-card h-64 p-6 flex flex-col justify-between cursor-pointer group">
                <div class="w-10 h-10 rounded-xl bg-pink-500/10 border border-pink-500/20 flex items-center justify-center text-pink-400 text-sm">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="z-10">
                    <p class="text-2xl font-bold text-white mb-1 font-display" id="note-count">0</p>
                    <p class="text-[10px] text-pink-300/70 uppercase tracking-wider font-bold">Love Jar</p>
                </div>
            </div>

            <!-- ä¾¿ç­¾ (ç§»é™¤AI) -->
            <div onclick="openMemoModal()" class="col-span-1 md:col-span-2 spotlight-card h-64 p-6 flex flex-col justify-between cursor-pointer group">
                <div class="w-10 h-10 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center text-yellow-400 text-sm">
                    <i class="fas fa-sticky-note"></i>
                </div>
                <div class="z-10">
                    <p class="text-2xl font-bold text-white mb-1 font-display" id="memo-count">0</p>
                    <p class="text-[10px] text-yellow-300/70 uppercase tracking-wider font-bold">Memos</p>
                </div>
            </div>

            <!-- å†³ç­–å™¨ (ç§»é™¤AI, æ¢å¤ä¸º8åˆ—) -->
            <div class="col-span-2 md:col-span-8 spotlight-card p-1 min-h-[160px] flex items-center justify-between overflow-hidden relative group">
                <img src="https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80" class="absolute inset-0 w-full h-full object-cover opacity-20 grayscale group-hover:grayscale-0 transition-all duration-700" alt="food">
                <div class="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-transparent"></div>
                
                <div class="flex flex-col md:flex-row items-center justify-between w-full h-full px-8 py-6 relative z-10">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-white/5 backdrop-blur border border-white/10 flex items-center justify-center">
                            <i class="fas fa-utensils text-gray-300"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] mb-1">DECISION MAKER</p>
                            <p id="food-display" class="text-2xl md:text-3xl font-bold text-white font-serif">ä»Šå¤©åƒä»€ä¹ˆ?</p>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <button onclick="spinFood()" class="px-6 py-2 rounded-full border border-white/20 bg-white/5 hover:bg-white hover:text-black text-[10px] font-bold transition-all duration-300 flex items-center justify-center gap-2 uppercase tracking-widest">
                            <i class="fas fa-random"></i> éšæœºé€‰æ‹©
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ‹çˆ±æ˜Ÿè¿ (4åˆ—) -->
            <div onclick="openHoroscopeModal()" class="col-span-2 md:col-span-4 spotlight-card p-1 min-h-[160px] flex items-center justify-center relative group cursor-pointer overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-900/40 to-purple-900/40"></div>
                <div class="flex flex-col items-center justify-center z-10 text-center p-6">
                    <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mb-3 animate-float">
                        <i class="fas fa-star text-indigo-300 text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white font-serif">æ‹çˆ±æ˜Ÿè¿</h3>
                    <p class="text-[10px] text-indigo-200/70 uppercase tracking-widest mt-1">Cosmic Forecast</p>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- ç…§ç‰‡å¢™ -->
<section class="py-24 relative z-20">
    <div class="max-w-[95rem] mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between mb-12 px-2">
            <h2 class="text-3xl font-bold text-white font-display">Gallery</h2>
            <div class="h-[1px] flex-grow bg-white/10 mx-6"></div>
            <p class="text-gray-500 text-xs uppercase tracking-widest">Shared Memories</p>
        </div>
        <div id="photo-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 auto-rows-[300px]"></div>
    </div>
</section>

<!-- é¡µè„š -->
<footer class="py-12 border-t border-white/5 text-center relative z-20 bg-black">
    <div class="text-sm font-bold tracking-widest text-white/40">US. <span class="text-[10px] font-normal">Cloud Storage</span></div>
    <p class="text-[10px] text-gray-600 mt-2">Built with Love & Supabase & Gemini AI</p>
</footer>

<!-- æ¨¡æ€æ¡†ç»„ä»¶ -->

<!-- Memo Modal (æ— AI) -->
<div id="memo-modal" class="modal-view items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-2xl h-[80vh] flex flex-col relative overflow-hidden">
        <div class="absolute inset-0 bg-yellow-500/5 pointer-events-none"></div>
        <div class="flex justify-between items-center p-6 border-b border-white/10 relative z-10">
            <h2 class="text-xl font-bold text-yellow-400">Thinking of You</h2>
            <div class="flex gap-2">
                <button onclick="createMemo()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-yellow-500 hover:text-black flex items-center justify-center transition"><i class="fas fa-plus text-xs"></i></button>
                <button onclick="closeMemoModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition"><i class="fas fa-times text-xs"></i></button>
            </div>
        </div>
        <div id="memo-list-container" class="flex-grow p-6 overflow-y-auto relative z-10"></div>
    </div>
</div>

<!-- Jar Modal (æ— AI) -->
<div id="jar-modal" class="modal-view items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-lg flex flex-col overflow-hidden relative">
        <div class="absolute top-0 right-0 w-64 h-64 bg-pink-500/20 rounded-full blur-[80px] pointer-events-none"></div>
        <div class="flex justify-between items-center p-6 relative z-10">
            <h2 class="text-xl font-bold text-pink-400">Love Jar</h2>
            <button onclick="closeJarModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
        </div>
        <div class="flex-grow flex flex-col justify-center p-8 relative z-10 text-center">
            <div class="min-h-[120px] flex items-center justify-center mb-8">
                <p id="jar-note-display" class="text-2xl font-serif text-white italic leading-relaxed"></p>
                <div id="note-animation" class="absolute text-6xl text-pink-500 opacity-0 transition-all duration-700 pointer-events-none">â¤ï¸</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="addNoteToJar()" class="btn-secondary py-4 rounded-2xl text-xs font-bold transition tracking-widest uppercase">æ”¾å…¥çº¸æ¡</button>
                <button onclick="drawNoteFromJar()" class="bg-pink-600 hover:bg-pink-500 text-white py-4 rounded-2xl text-xs font-bold transition shadow-lg shadow-pink-900/40 tracking-widest uppercase">æŠ½å–ä¸€å¼ </button>
            </div>
        </div>
    </div>
</div>

<!-- Horoscope Modal -->
<div id="horoscope-modal" class="modal-view items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-lg max-h-[85vh] flex flex-col overflow-hidden relative bg-[#0a0a0a]">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80')] bg-cover opacity-20"></div>
        <div class="flex justify-between items-center p-6 relative z-10 border-b border-white/10 flex-shrink-0">
            <h2 class="text-xl font-bold text-indigo-400">ä»Šæ—¥æ‹çˆ±æ˜Ÿè¿</h2>
            <button onclick="closeHoroscopeModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
        </div>
        <div class="flex-grow flex flex-col items-center justify-start p-10 relative z-10 text-center overflow-y-auto scrollbar-hide">
            <div id="crystal-ball" class="text-6xl text-indigo-400 mb-6 animate-float opacity-80 mt-4"><i class="fas fa-globe"></i></div>
            <div id="horoscope-content" class="text-gray-300 text-sm leading-relaxed font-serif min-h-[100px] flex items-center justify-center">
                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼ŒæŸ¥æ”¶å®‡å®™ç»™ä½ ä»¬çš„ä¸“å±å»ºè®®ã€‚
            </div>
            <button onclick="generateHoroscope()" class="mt-8 ai-btn-gradient px-8 py-3 rounded-full text-xs font-bold tracking-widest uppercase transition shadow-lg shadow-indigo-500/30 flex-shrink-0 mb-4">
                <i class="fas fa-sparkles mr-2"></i> å¼€å§‹å åœ
            </button>
        </div>
    </div>
</div>

<!-- Calendar Modal (AI ä¿ç•™) -->
<div id="calendar-modal" class="modal-view items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-3xl h-[85vh] flex flex-col relative overflow-hidden">
        <div class="absolute inset-0 bg-blue-500/5 pointer-events-none"></div>
        <div class="p-6 border-b border-white/10 relative z-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-blue-400">Time Travel</h2>
                <button onclick="closeCalendarModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
            </div>
            <div class="flex gap-2">
                <div class="relative flex-grow">
                    <input type="text" id="event-title-input" placeholder="å‡†å¤‡å»åšä»€ä¹ˆ..." class="w-full rounded-lg pl-4 pr-10 py-2 text-sm bg-black/20 border-white/10 focus:border-blue-500/50">
                    <button onclick="generateDateIdea()" class="absolute right-2 top-1/2 -translate-y-1/2 text-blue-400 hover:text-white transition" title="AI çº¦ä¼šçµæ„Ÿ">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                <input type="date" id="event-date-input" class="rounded-lg px-4 py-2 text-sm bg-black/20 border-white/10 focus:border-blue-500/50">
                <button onclick="addCalendarEvent()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-lg text-sm transition"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div id="timeline-container" class="flex-grow p-8 overflow-y-auto space-y-6 relative z-10"></div>
    </div>
</div>

<!-- Photo Assistant Modal (æ–°å¢åŠŸèƒ½: æ‹ç…§/ä¸Šä¼  + AI çº¿ç¨¿ + è‡ªåŠ¨è½¬æ–‡å­—) -->
<div id="photo-modal" class="modal-view items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative bg-[#0a0a0a]">
        <div class="absolute inset-0 bg-teal-500/5 pointer-events-none"></div>
        <div class="flex justify-between items-center p-6 relative z-10 border-b border-white/10 flex-shrink-0">
            <h2 class="text-xl font-bold text-teal-400">ä¸“å±æ‘„å½±å¸ˆ</h2>
            <button onclick="closePhotoModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
        </div>
        <div class="flex-grow flex flex-col p-6 relative z-10 overflow-y-auto scrollbar-hide items-center">
            
            <!-- ä¸Šä¼ /æ‹ç…§åŒºåŸŸ -->
            <label for="scene-upload" class="w-full aspect-[4/3] rounded-xl border-2 border-dashed border-white/20 hover:border-teal-500/50 flex flex-col items-center justify-center cursor-pointer bg-white/5 transition mb-4 relative overflow-hidden group">
                <img id="scene-preview" class="absolute inset-0 w-full h-full object-cover hidden opacity-50 group-hover:opacity-30 transition">
                <div class="text-center z-10 pointer-events-none">
                    <i class="fas fa-camera text-3xl text-gray-400 mb-2 group-hover:text-teal-400"></i>
                    <p class="text-xs text-gray-400">ç‚¹å‡»æ‹ç…§ / ä¸Šä¼ åœºæ™¯å›¾</p>
                </div>
            </label>
            <input id="scene-upload" type="file" accept="image/*" capture="environment" class="hidden" onchange="handleSceneUpload(event)">

            <!-- ç”ŸæˆæŒ‰é’® -->
            <button id="generate-comp-btn" onclick="generateComposition()" class="w-full ai-btn-gradient py-3 rounded-xl text-xs font-bold tracking-widest uppercase transition opacity-50 cursor-not-allowed flex items-center justify-center gap-2 mb-6" disabled>
                <i class="fas fa-magic"></i> ç”Ÿæˆæ‹æ‘„æŒ‡å¯¼
            </button>

            <!-- ç»“æœå±•ç¤º -->
            <div id="comp-result-container" class="w-full hidden space-y-4">
                <!-- å›¾ç‰‡ç»“æœ (å¦‚æœç”ŸæˆæˆåŠŸ) -->
                <div id="img-result-box" class="hidden">
                    <p class="text-xs text-teal-400 mb-2 font-bold uppercase tracking-wider text-center">AI å»ºè®®æ„å›¾ (çº¿ç¨¿)</p>
                    <div class="relative w-full rounded-xl overflow-hidden border border-teal-500/30">
                        <img id="comp-result-img" class="w-full h-auto block" src="">
                    </div>
                </div>

                <!-- æ–‡å­—ç»“æœ (å…œåº•æˆ–è¡¥å……) -->
                <div id="text-result-box" class="hidden bg-white/5 p-4 rounded-xl border border-white/10">
                    <p class="text-xs text-teal-400 mb-2 font-bold uppercase tracking-wider flex items-center gap-2"><i class="fas fa-file-alt"></i> æ„å›¾è¯¦æƒ…</p>
                    <div id="comp-text-content" class="text-gray-300 text-sm leading-relaxed font-serif whitespace-pre-line"></div>
                </div>
                
                <p class="text-[10px] text-gray-500 mt-2 text-center">AI å»ºè®®ä»…ä¾›å‚è€ƒï¼Œé‡è¦çš„æ˜¯æ•æ‰çˆ±æ„ â¤ï¸</p>
            </div>

        </div>
    </div>
</div>

<!-- ç¯ç®± -->
<div id="lightbox" class="fixed inset-0 bg-black/95 z-[3000] hidden items-center justify-center opacity-0 transition-opacity duration-300">
    <button onclick="closeLightbox()" class="absolute top-6 right-6 text-white/50 hover:text-white text-2xl transition z-50"><i class="fas fa-times"></i></button>
    <button id="lightbox-prev" class="absolute left-6 text-white/50 hover:text-white text-3xl transition p-4 z-50"><i class="fas fa-angle-left"></i></button>
    <img id="lightbox-img" class="max-w-[95vw] max-h-[90vh] object-contain shadow-2xl rounded-sm select-none" src="">
    <button id="lightbox-next" class="absolute right-6 text-white/50 hover:text-white text-3xl transition p-4 z-50"><i class="fas fa-angle-right"></i></button>
</div>

<script>
    // --- 0. ç³»ç»Ÿé…ç½® ---
    const SUPABASE_URL = 'https://umwoybzmukvkbzpplqss.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtd295YnptdWt2a2J6cHBscXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjQ3OTQsImV4cCI6MjA4MDg0MDc5NH0.EZ7shXnBKQpxPAd6wB3XxrfTnE3KrajGwtmTl1UvuLg';
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const STORAGE_BUCKET = 'love-storage';

    const SECRET_CODE = "0726";
    // ğŸ”´ ä¸Šä¼ æç¤º: å¦‚æœä½ å°†ç½‘ç«™ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè¯·å» Google AI Studio è·å– API Key å¹¶å¡«å…¥ä¸‹æ–¹å¼•å·ä¸­
    // å¦åˆ™ AI åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ã€‚ç›®å‰åœ¨é¢„è§ˆç¯å¢ƒä¸­æ˜¯è‡ªåŠ¨å¡«å……çš„ã€‚
    const k_part1 = "AIzaSyBtAQR_74WUdRNhJSUuC";
    const k_part2 = "2MN4c9h3bfScBY";
    const apiKey = k_part1 + k_part2;

    // --- Image Compression Helper ---
    // æ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼šé™åˆ¶æœ€å¤§å®½åº¦ä¸º 800pxï¼Œå‹ç¼©è´¨é‡ 0.7
    function resizeImage(file, maxWidth, quality, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // è½¬æ¢ä¸º Base64
                callback(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // --- Gemini AI Helper (General Text) ---
    async function callGemini(prompt) {
        if (!prompt) return null;
        if (!apiKey && window.location.hostname !== 'localhost' && !window.location.hostname.includes('googleusercontent')) {
             alert("è¯·åœ¨ä»£ç ä¸­é…ç½®æ‚¨çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚");
             return null;
        }
        
        const loading = document.getElementById('loading-layer');
        const loadingText = document.getElementById('loading-text');
        
        loading.style.display = 'flex';
        loadingText.innerText = "æ­£åœ¨å’¨è¯¢æ˜Ÿæ˜Ÿ...";
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }]
        };

        // Retry logic for Quota Exceeded (429)
        let attempt = 0;
        const maxRetries = 5;
        let delay = 1000; // 1s start

        while (attempt < maxRetries) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 429) {
                    const errData = await response.json().catch(() => ({}));
                    console.warn(`Attempt ${attempt+1} failed: Quota Exceeded. Retrying in ${delay}ms...`);
                    throw new Error("QUOTA_EXCEEDED");
                }

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || response.statusText);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;

            } catch (error) {
                if (error.message === "QUOTA_EXCEEDED") {
                    attempt++;
                    if (attempt >= maxRetries) {
                        alert("AI è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åï¼ˆçº¦30ç§’ï¼‰å†è¯•ã€‚");
                        return null;
                    }
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2; // Exponential backoff
                } else {
                    console.error("AI Error:", error);
                    alert(`AI è¿æ¥å¤±è´¥: ${error.message}`);
                    return null;
                }
            } finally {
                if (attempt >= maxRetries || (attempt === 0 && loading.style.display !== 'none')) {
                     // Ensure loading is hidden only on final success or failure
                }
            }
        }
        loading.style.display = 'none';
        return null; 
    }

    // --- Gemini Text Analysis from Image (Fallback) ---
    async function callGeminiTextAnalysis(base64Image) {
        const loading = document.getElementById('loading-layer');
        document.getElementById('loading-text').innerText = "ç”Ÿæˆæ–‡å­—æŒ‡å¯¼ä¸­...";
        loading.style.display = 'flex';

        // ä½¿ç”¨é€šç”¨æ¨¡å‹è¿›è¡Œå¤šæ¨¡æ€åˆ†æ (è¯†å›¾ + æ–‡æœ¬)
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [
                    { text: "ä½œä¸ºä¸“ä¸šæ‘„å½±å¸ˆï¼Œè¯·åˆ†æè¿™å¼ åœºæ™¯å›¾ï¼Œå¹¶ç»™å‡ºæå…·æ“ä½œæ€§çš„æ„å›¾æŒ‡å¯¼ã€‚ä¸è¦è®²å¤§é“ç†ï¼Œç›´æ¥å‘Šè¯‰æˆ‘ï¼š\n1. **ç«™ä½åæ ‡**ï¼šæŠŠç”»é¢æƒ³è±¡æˆä¹å®«æ ¼ï¼Œäººç‰©åº”è¯¥ç«™åœ¨å…·ä½“çš„å“ªä¸ªç‚¹ï¼ˆå¦‚â€œå³ä¸Šäº¤ç‚¹â€ã€â€œå·¦ä¾§ç«–çº¿ä¸­é—´â€ï¼‰ï¼Ÿ\n2. **ç›¸æœºæœºä½**ï¼šéœ€è¦ä»°æ‹ã€ä¿¯æ‹è¿˜æ˜¯å¹³è§†ï¼Ÿè·ç¦»äººç‰©å¤šè¿œï¼Ÿ\n3. **å§¿åŠ¿å¼•å¯¼**ï¼šåœ¨è¿™ä¸ªå…·ä½“åœºæ™¯ä¸‹ï¼Œäººç‰©åº”è¯¥åšä»€ä¹ˆåŠ¨ä½œæœ€è‡ªç„¶ï¼Ÿ" },
                    { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                ]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) throw new Error("Analysis failed");
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "æ— æ³•ç”Ÿæˆå»ºè®®ï¼Œè¯·é‡è¯•ã€‚";
        } catch (e) {
            console.error(e);
            return "AI å¼€å°å·®äº†ï¼Œè¯·ç¨åå†è¯•ã€‚";
        } finally {
            loading.style.display = 'none';
        }
    }

    // --- Gemini Vision Helper (For Photo Assistant) ---
    async function callGeminiVision(base64Image) {
        const loading = document.getElementById('loading-layer');
        document.getElementById('loading-text').innerText = "AI æ­£åœ¨ç»˜åˆ¶çº¿ç¨¿...";
        loading.style.display = 'flex';
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [
                {
                    parts: [
                        { text: "ä½œä¸ºæ‘„å½±å¸ˆï¼Œè¯·åœ¨åŸå›¾ä¸Šç”»å‡ºæ„å›¾è¾…åŠ©çº¿ï¼ˆå¦‚ä¹å®«æ ¼ã€å¼•å¯¼çº¿ï¼‰å’Œä¸€ä¸ªç®€ç¬”ç”»å°äººæ¥æŒ‡ç¤ºå¥³æœ‹å‹åº”è¯¥ç«™çš„ä½ç½®ï¼Œç”¨é«˜å¯¹æ¯”åº¦çš„çº¿æ¡ã€‚ä¿ç•™åŸå›¾èƒŒæ™¯ã€‚" },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }
            ],
            generationConfig: {
                responseModalities: ["TEXT", "IMAGE"] // Allow fallbacks
            }
        };

        // Retry logic for Quota Exceeded (429)
        let attempt = 0;
        const maxRetries = 2; // Reduce retries to fail faster to text fallback
        let delay = 1000;

        while (attempt < maxRetries) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 429) {
                    console.warn(`Image Gen Attempt ${attempt+1} failed: Quota. Retrying...`);
                    throw new Error("QUOTA_EXCEEDED");
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                // Check for image
                const imgData = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!imgData) {
                    throw new Error("No image generated");
                }
                
                return `data:image/jpeg;base64,${imgData}`;

            } catch (error) {
                if (error.message === "QUOTA_EXCEEDED") {
                    attempt++;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2; 
                } else {
                    console.error("Image Gen Failed, switching to text fallback."); 
                    return null; // Return null to trigger fallback
                }
            }
        }
        return null; // All retries failed
    }

    // --- 1. é”å±ä¸å…¥åœº ---
    let inputCode = "";
    
    function enterDigit(d) {
        if(inputCode.length < 4) {
            inputCode += d;
            updateDots();
            if(inputCode.length === 4) checkCode();
        }
    }
    
    function backspace() {
        inputCode = inputCode.slice(0, -1);
        updateDots();
    }
    
    function clearPasscode() {
        inputCode = "";
        updateDots();
    }
    
    function updateDots() {
        const dots = document.querySelectorAll('.passcode-dot');
        dots.forEach((dot, idx) => {
            if(idx < inputCode.length) dot.classList.add('active');
            else { dot.classList.remove('active'); dot.classList.remove('error'); }
        });
    }
    
    function checkCode() {
        if(inputCode === SECRET_CODE) {
            document.getElementById('lock-screen').classList.add('unlocked');
            const audio = document.getElementById('bgm-audio');
            audio.play().catch(()=>{}); 
            initApp();
        } else {
            const dots = document.querySelectorAll('.passcode-dot');
            dots.forEach(d => d.classList.add('error'));
            setTimeout(clearPasscode, 500);
        }
    }

    function initApp() {
        new TypeIt("#typewriter-title", {
            strings: ["Love.", "Cloud."],
            speed: 150,
            breakLines: true,
            lifeLike: true,
            cursor: false
        }).go();
        
        fetchAndRenderPhotos();
        fetchAllNotes();
        fetchEvents();
        animateParticles();
    }

    // --- 2. è§†è§‰ç‰¹æ•ˆ ---
    let lastTime = 0;
    document.addEventListener('mousemove', (e) => {
        const now = Date.now();
        if (now - lastTime < 50) return; 
        lastTime = now;
        
        const heart = document.createElement('div');
        heart.classList.add('heart-trail');
        heart.innerHTML = 'â¤';
        heart.style.left = e.clientX + 'px';
        heart.style.top = e.clientY + 'px';
        heart.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1000);
    });

    const cards = document.querySelectorAll('.spotlight-card');
    document.getElementById('cards-container').onmousemove = e => {
        for(const card of cards) {
            const rect = card.getBoundingClientRect();
            card.style.setProperty("--mouse-x", `${e.clientX - rect.left}px`);
            card.style.setProperty("--mouse-y", `${e.clientY - rect.top}px`);
        }
    };

    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let width, height, particles = [];
    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    class Particle {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * width; this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
            this.size = Math.random() * 2; this.alpha = Math.random() * 0.5 + 0.1;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            if (this.x < 0 || this.x > width || this.y < 0 || this.y > height) this.reset();
        }
        draw() {
            ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
        }
    }
    for(let i=0; i<60; i++) particles.push(new Particle());
    function animateParticles() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animateParticles);
    }

    // --- 3. æ ¸å¿ƒåŠŸèƒ½é€»è¾‘ ---
    function animateValue(obj, start, end, duration) {
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // Photo Wall
    const staticPhotos = [
        { src: 'p1.jpg', span: 'md:col-span-2 md:row-span-2', title: 'åŒ—äº¬' },
        { src: 'p2.jpg', span: 'md:col-span-1 md:row-span-1', title: 'Love' },
        { src: 'p3.jpg', span: 'md:col-span-1 md:row-span-2', title: 'å°ä¸ƒå­”' },
        { src: 'p4.jpg', span: 'md:col-span-1 md:row-span-1', title: 'æ‹ç«‹å¾—çš„æˆ‘ä»¬' },
        { src: 'p5.jpg', span: 'md:col-span-2 md:row-span-1', title: 'å®å®æœ¬å®' }
    ];
    let currentPhotoList = [];

    async function fetchAndRenderPhotos() {
        let allPhotos = [...staticPhotos];
        try {
            const { data } = await _supabase.from('Gallery').select('*').order('created_at', { ascending: false });
            if (data) {
                const cloud = data.map(o => ({ id: o.id, src: o.url, title: o.title || 'Memory', isCloud: true }));
                allPhotos = [...cloud, ...staticPhotos];
            }
        } catch(e) {}
        currentPhotoList = allPhotos.map(p => p.src);
        const grid = document.getElementById('photo-grid');
        grid.innerHTML = '';
        allPhotos.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `bento-card group relative overflow-hidden rounded-xl bg-gray-900 cursor-pointer ${p.span||''}`;
            div.dataset.aos = 'fade-up';
            div.innerHTML = `
                <img src="${p.src}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
                ${p.isCloud ? `<div class="absolute top-2 right-2 w-8 h-8 bg-black/50 backdrop-blur rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:bg-red-500/80" onclick="event.stopPropagation(); deletePhoto('${p.id}')"><i class="fas fa-trash-alt text-white text-xs"></i></div>` : ''}
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex items-end p-4">
                    <span class="text-white font-bold tracking-wider">${p.title}</span>
                </div>
            `;
            div.onclick = () => showLightbox(i);
            grid.appendChild(div);
        });
    }

    async function uploadToCloud(e) {
        const f = e.target.files[0]; if(!f) return;
        document.getElementById('loading-layer').style.display = 'flex';
        try {
            const fileName = `photo-${Date.now()}`;
            const { error: upErr } = await _supabase.storage.from(STORAGE_BUCKET).upload(fileName, f);
            if(upErr) throw upErr;
            const { data: { publicUrl } } = _supabase.storage.from(STORAGE_BUCKET).getPublicUrl(fileName);
            await _supabase.from('Gallery').insert([{ url: publicUrl, title: 'Memory' }]);
            fetchAndRenderPhotos();
        } catch(err) { alert("ä¸Šä¼ å¤±è´¥"); }
        finally { document.getElementById('loading-layer').style.display = 'none'; e.target.value = ''; }
    }

    async function deletePhoto(id) {
        if(!confirm("åˆ é™¤è¿™å¼ å›å¿†?")) return;
        await _supabase.from('Gallery').delete().eq('id', id);
        fetchAndRenderPhotos();
    }

    // Lightbox
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    let curIdx = 0;
    function showLightbox(i) { curIdx = i; lbImg.src = currentPhotoList[i]; lb.style.display='flex'; setTimeout(()=>lb.style.opacity='1',10); }
    function closeLightbox() { lb.style.opacity='0'; setTimeout(()=>lb.style.display='none',300); }
    document.getElementById('lightbox-prev').onclick = (e) => { e.stopPropagation(); curIdx=(curIdx-1+currentPhotoList.length)%currentPhotoList.length; lbImg.src=currentPhotoList[curIdx]; };
    document.getElementById('lightbox-next').onclick = (e) => { e.stopPropagation(); curIdx=(curIdx+1)%currentPhotoList.length; lbImg.src=currentPhotoList[curIdx]; };

    // Music
    const audio = document.getElementById('bgm-audio');
    const playlist = ['bgm.mp3', 'bgm1.mp3', 'bgm2.mp3']; // ä½ çš„æœ¬åœ°æ–‡ä»¶
    audio.src = playlist[0]; 
    
    audio.addEventListener('ended', () => {
       const nextIndex = Math.floor(Math.random() * playlist.length);
       audio.src = playlist[nextIndex];
       audio.play().catch(e => console.log("Auto play prevented"));
    });
    
    function toggleBGM() {
        const ui = document.getElementById('music-player-ui');
        const btn = document.getElementById('bgm-btn');
        const title = document.getElementById('music-title');
        
        if(audio.paused) {
            audio.play().then(() => {
                ui.classList.add('music-playing');
                btn.innerHTML = '<i class="fas fa-pause text-xs"></i>';
                title.innerText = "Playing...";
            }).catch(() => {
                alert("æ’­æ”¾å¤±è´¥ã€‚è¯·æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰åä¸º bgm.mp3 çš„æ–‡ä»¶ã€‚");
            });
        } else {
            audio.pause();
            ui.classList.remove('music-playing');
            btn.innerHTML = '<i class="fas fa-play text-xs pl-0.5"></i>';
            title.innerText = "Paused";
        }
    }

    function toggleModal(id, show) {
        const el = document.getElementById(id);
        if(show) { el.classList.add('active'); setTimeout(()=>el.style.opacity='1',10); }
        else { el.style.opacity='0'; setTimeout(()=>el.classList.remove('active'),400); }
    }

    // --- Memos (æ— AI) ---
    function openMemoModal() { toggleModal('memo-modal', true); renderMemos(); }
    function closeMemoModal() { toggleModal('memo-modal', false); }
    async function renderMemos() {
        const c = document.getElementById('memo-list-container');
        c.innerHTML = '<p class="text-gray-500 text-sm text-center">åŠ è½½ä¸­...</p>';
        const { data } = await _supabase.from('Memo').select('*').order('created_at', {ascending:false});
        if(!data || !data.length) { c.innerHTML = '<p class="text-gray-500 text-sm text-center mt-10">ç©ºç©ºå¦‚ä¹Ÿ...</p>'; return; }
        animateValue(document.getElementById('memo-count'), 0, data.length, 1000);
        c.innerHTML = data.map(m => `
            <div class="bg-white/5 p-4 rounded-xl mb-3 border border-white/5 hover:border-yellow-500/30 transition group flex justify-between">
                <p class="text-gray-300 text-sm">${m.content}</p>
                <button onclick="delMemo('${m.id}')" class="text-red-400 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
            </div>`).join('');
    }
    async function createMemo() {
        const txt = prompt("å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•:");
        if(txt) { await _supabase.from('Memo').insert([{content:txt}]); renderMemos(); }
    }
    async function delMemo(id) { await _supabase.from('Memo').delete().eq('id',id); renderMemos(); }

    // --- Jar (æ— AI) ---
    function openJarModal() { toggleModal('jar-modal', true); }
    function closeJarModal() { toggleModal('jar-modal', false); }
    async function fetchAllNotes() {
        const { count } = await _supabase.from('LoveNote').select('*', { count: 'exact', head: true });
        if(count !== null) animateValue(document.getElementById('note-count'), 0, count, 1000);
    }
    async function addNoteToJar() {
        const t = prompt("æ”¾å…¥ä½ çš„å°å¿ƒæ€:");
        if(t) { await _supabase.from('LoveNote').insert([{content:t}]); alert("å·²æ”¾å…¥!"); fetchAllNotes(); }
    }
    async function drawNoteFromJar() {
        const d = document.getElementById('jar-note-display');
        const a = document.getElementById('note-animation');
        d.innerText = ""; a.style.opacity = 1; a.style.transform = "scale(1.5)";
        const { data } = await _supabase.from('LoveNote').select('*');
        setTimeout(() => {
            a.style.opacity = 0; a.style.transform = "scale(1)";
            if(data && data.length) d.innerText = `â€œ${data[Math.floor(Math.random()*data.length)].content}â€`;
            else d.innerText = "ç“¶å­æ˜¯ç©ºçš„...";
        }, 800);
    }

    // --- Calendar (AI ä¿ç•™) ---
    function openCalendarModal() { toggleModal('calendar-modal', true); fetchEvents(); }
    function closeCalendarModal() { toggleModal('calendar-modal', false); }
    async function fetchEvents() {
        const { data } = await _supabase.from('LoveEvent').select('*').order('eventDate');
        const c = document.getElementById('timeline-container');
        if(!data) return;
        animateValue(document.getElementById('event-count'), 0, data.length, 1000);
        c.innerHTML = data.map(e => {
            const date = new Date(e.eventDate);
            const diff = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
            return `
            <div class="flex gap-4 relative">
                <div class="w-12 text-xs text-gray-500 pt-4 text-right">${date.getMonth()+1}/${date.getDate()}</div>
                <div class="w-0.5 bg-white/10 relative"><div class="absolute top-4 left-[-4px] w-2.5 h-2.5 rounded-full ${diff>0?'bg-blue-500 shadow-blue-500/50 shadow-lg':'bg-gray-600'}"></div></div>
                <div class="flex-grow bg-white/5 p-4 rounded-xl border border-white/5 flex justify-between group">
                    <div><h4 class="text-gray-200 font-bold">${e.title}</h4><span class="text-xs text-gray-500">${diff>0 ? 'è¿˜æœ‰ ' + diff + ' å¤©' : 'å·²è¿‡å» ' + Math.abs(diff) + ' å¤©'}</span></div>
                    <button onclick="delEvent('${e.id}')" class="text-red-400 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    }
    async function addCalendarEvent() {
        const t = document.getElementById('event-title-input').value;
        const d = document.getElementById('event-date-input').value;
        if(t && d) { await _supabase.from('LoveEvent').insert([{title:t, eventDate:d}]); fetchEvents(); }
    }
    async function delEvent(id) { await _supabase.from('LoveEvent').delete().eq('id',id); fetchEvents(); }

    // âœ¨ AI Feature 1: Date Planner (Chinese)
    async function generateDateIdea() {
        const dateVal = document.getElementById('event-date-input').value;
        const context = dateVal ? `æ—¥æœŸæ˜¯ ${dateVal}` : "ä¸ºäº†ä¸€ä¸ªå³å°†åˆ°æ¥çš„å‘¨æœ«";
        const result = await callGemini(`ä¸ºä¸€å¯¹æƒ…ä¾£æƒ³ä¸€ä¸ªæµªæ¼«çš„çº¦ä¼šè®¡åˆ’åç§°ï¼Œç”¨ä¸­æ–‡ï¼Œ${context}ã€‚ç®€çŸ­æœ‰åŠ›(10å­—ä»¥å†…)ï¼Œåªè¿”å›æ ‡é¢˜ã€‚`);
        if(result) {
            const input = document.getElementById('event-title-input');
            input.value = result.replace(/['"]+/g, '');
            input.classList.add('animate-pulse');
            setTimeout(() => input.classList.remove('animate-pulse'), 1000);
        }
    }
    
    // Food Spin (Original Chinese)
    const foods = ["ç«é”…", "æ—¥æ–™", "çƒ§çƒ¤", "è½»é£Ÿ", "æ³°å›½èœ", "KFC", "ç‚’èœ", "å–ç²¥", "å®å®çš„è„¸"];
    function spinFood() {
        let i=0, t=setInterval(() => {
            document.getElementById('food-display').innerText = foods[Math.floor(Math.random()*foods.length)];
            i++; if(i>15) clearInterval(t);
        }, 80);
    }
    
    // âœ¨ New AI Feature 3: Love Horoscope (Chinese)
    function openHoroscopeModal() {
        toggleModal('horoscope-modal', true);
        document.getElementById('horoscope-content').innerText = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼ŒæŸ¥æ”¶å®‡å®™ç»™ä½ ä»¬çš„ä¸“å±å»ºè®®ã€‚";
    }
    function closeHoroscopeModal() { toggleModal('horoscope-modal', false); }
    
    async function generateHoroscope() {
        const days = document.getElementById('days-counter').innerText;
        const result = await callGemini(`ä½œä¸ºä¸€ä½ç¥ç§˜çš„å æ˜Ÿå¸ˆï¼Œä¸ºä¸€å¯¹å·²ç»åœ¨ä¸€èµ· ${days} å¤©çš„æƒ…ä¾£ï¼Œç”Ÿæˆä»Šå¤©çš„"æ‹çˆ±æ˜Ÿè¿"ã€‚å†…å®¹åŒ…æ‹¬ï¼šä»Šæ—¥æ‹çˆ±è¿åŠ¿æŒ‡æ•°(1-5æ˜Ÿ)ï¼Œä¸€å¥æµªæ¼«çš„è¿åŠ¿è§£æï¼Œä»¥åŠä¸€ä¸ªæå‡æ„Ÿæƒ…çš„å°å»ºè®®ã€‚é£æ ¼æ¸©é¦¨ç¥ç§˜ï¼Œç”¨ä¸­æ–‡ã€‚`);
        if(result) {
            // ç®€å•çš„æ ¼å¼åŒ–æ˜¾ç¤º
            document.getElementById('horoscope-content').innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*/g, '');
        } else {
            // å¤±è´¥æ—¶åœ¨å¡ç‰‡ä¸Šæ˜¾ç¤ºé”™è¯¯
            document.getElementById('horoscope-content').innerHTML = "<span class='text-red-400'>å åœå¤±è´¥ã€‚</span><br><span class='text-xs text-gray-500'>è¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚</span>";
        }
    }

    // âœ¨ New AI Feature: Photo Assistant Logic (Auto Resize + Text Fallback)
    let sceneBase64 = null;

    function openPhotoModal() { toggleModal('photo-modal', true); }
    function closePhotoModal() { toggleModal('photo-modal', false); }

    function handleSceneUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        // ä½¿ç”¨å‹ç¼©é€»è¾‘
        resizeImage(file, 800, 0.7, (resizedBase64) => {
             const preview = document.getElementById('scene-preview');
             preview.src = resizedBase64;
             preview.classList.remove('hidden');
             
             // Extract pure base64
             sceneBase64 = resizedBase64.split(',')[1];
             
             const btn = document.getElementById('generate-comp-btn');
             btn.disabled = false;
             btn.classList.remove('opacity-50', 'cursor-not-allowed');
             
             // Hide previous results
             document.getElementById('comp-result-container').classList.add('hidden');
             document.getElementById('img-result-box').classList.add('hidden');
             document.getElementById('text-result-box').classList.add('hidden');
        });
    }

    async function generateComposition() {
        if (!sceneBase64) return;
        
        const container = document.getElementById('comp-result-container');
        container.classList.remove('hidden');
        
        // 1. Try Image Gen
        const resultImgUrl = await callGeminiVision(sceneBase64);
        
        if (resultImgUrl) {
            // If image success
            const imgBox = document.getElementById('img-result-box');
            const img = document.getElementById('comp-result-img');
            img.src = resultImgUrl;
            imgBox.classList.remove('hidden');
        } else {
            // 2. If Image fails (null), try text fallback
            const textResult = await callGeminiTextAnalysis(sceneBase64);
            const textBox = document.getElementById('text-result-box');
            const textContent = document.getElementById('comp-text-content');
            
            textContent.innerHTML = textResult.replace(/\n/g, '<br>').replace(/\*\*/g, '');
            textBox.classList.remove('hidden');
        }
        
        // Scroll to result
        container.scrollIntoView({ behavior: 'smooth' });
    }

    // Days Counter
    const startDate = new Date("2025-05-04");
    document.getElementById('days-counter').innerText = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));

    AOS.init({ once: true, duration: 800 });
</script>
</body>
</html>